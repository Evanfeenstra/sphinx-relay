name: Push
on: 
  pull_request:
    branches:
      - master
    
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        name: kevkevinpal/sphinx-relay      
        path: relay
        branch: stackOnDrone
    - name: Build Relay
      run: |
        cd ./relay && npm install --dev && docker build -t sphinxlightning/sphinx-relay-test . 
    - name: Checkout stack
      run: |
        git clone -b relayPRTesting https://github.com/kevkevinpal/sphinx-stack.git stack
        #- uses: actions/checkout@v2
        #  with:
        #    name: kevkevinpal/sphinx-stack
        #    path: stack
        #    branch: relayPRTesting
    - name: Turn on Stack 
      working-directory: ./stack
      run: |
        ls -a && docker-compose pull && export COMPOSE_HTTP_TIMEOUT=120; docker-compose up -d 
    - name: Enable docker.host.internal for Ubuntu
      run: |
        echo "172.17.0.1 host.docker.internal" >> /etc/hosts
    - name: Check for NODES.json
      working-directory: ./stack
      run: |
        sleep 120; docker logs stack_relaysetup_1; docker logs stack_lndsetup_1; docker logs alice-lnd.sphinx; docker wait stack_relaysetup_1 
    - name: Run tests
      working-directory: ./relay
      run: |
        npm run test
        #;  cat ./relay/NODES.json;  cp ./relay/NODES.json ../relay/src/tests/configs/nodes.json
